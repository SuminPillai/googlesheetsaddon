<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      color: #333;
    }
  </style>
</head>
<body class="p-4 bg-gray-100 h-full">

  <!-- Main Container -->
  <div class="flex flex-col space-y-4 h-full">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-xl font-bold">20 Percent Price Data</h1>
      <p class="text-sm text-gray-500">Enter stock symbols and date range to fetch financial data.</p>
    </div>

    <!-- User Input Section -->
    <div class="flex-grow space-y-3 overflow-y-auto">

      <!-- Stock Symbol Input -->
      <div>
        <label for="stockSymbol" class="block text-sm font-medium text-gray-700">Stock Symbol (Single):</label>
        <div class="mt-1 flex rounded-md shadow-sm">
          <input type="text" id="stockSymbol" value="MSFT" placeholder="MSFT" class="flex-1 block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
          <button id="getStockSymbolFromCell" class="ml-2 inline-flex items-center rounded-md border border-gray-300 bg-white px-3 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Get from Cell
          </button>
        </div>
      </div>

      <!-- Ticker Range Input -->
      <div>
        <label for="tickerRange" class="block text-sm font-medium text-gray-700">Ticker Range (e.g., A1:A10):</label>
        <div class="mt-1 flex rounded-md shadow-sm">
          <input type="text" id="tickerRange" placeholder="A1:A10" class="flex-1 block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
          <button id="getTickersFromRange" class="ml-2 inline-flex items-center rounded-md border border-gray-300 bg-white px-3 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Get from Range
          </button>
        </div>
      </div>

      <!-- From Date Input -->
      <div>
        <label for="fromDate" class="block text-sm font-medium text-gray-700">From Date:</label>
        <div class="mt-1 flex rounded-md shadow-sm">
          <input type="date" id="fromDate" class="flex-1 block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
          <button id="getFromDateFromCell" class="ml-2 inline-flex items-center rounded-md border border-gray-300 bg-white px-3 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Get from Cell
          </button>
        </div>
      </div>

      <!-- To Date Input -->
      <div>
        <label for="toDate" class="block text-sm font-medium text-gray-700">To Date:</label>
        <div class="mt-1 flex rounded-md shadow-sm">
          <input type="date" id="toDate" class="flex-1 block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
          <button id="getToDateFromCell" class="ml-2 inline-flex items-center rounded-md border border-gray-300 bg-white px-3 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Get from Cell
          </button>
        </div>
      </div>

      <!-- Column Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Select Columns:</label>
        <div class="mt-1 border border-gray-300 rounded-md p-2 h-40 overflow-y-auto bg-white">
          <input type="text" id="columnSearch" placeholder="Search columns..." class="mb-2 block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
          <div id="columnCheckboxes"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-auto">
      <div id="message" class="text-sm p-2 text-center text-gray-700 bg-gray-200 rounded-md hidden"></div>
      <button id="fetchData" class="mt-4 w-full flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
        Fetch Data
      </button>
    </div>
  </div>

  <script>
    const backendUrl = "https://excel-addin-backend-1088354707719.asia-south1.run.app";
    const columns = ["Date", "Open", "High", "Low", "Close", "Volume", "1_Day_%_Change", "3_Day_%_Change", "1_Week_%_Change", "1_Month_%_Change", "3_Month_%_Change", "6_Month_%_Change", "1_Year_%_Change", "Price_MA_10", "Price_MA_20", "Price_MA_50", "Price_MA_100", "Price_MA_200", "Volatility_10", "Volatility_20", "Volatility_50", "Volatility_100", "Volatility_200", "Volume_MA_10", "Volume_MA_20", "Volume_MA_50", "Volume_MA_100", "Volume_MA_200"];

    function displayMessage(text, isError = false) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.classList.remove('hidden', 'bg-gray-200', 'text-gray-700', 'bg-red-100', 'text-red-700');
      if (isError) {
        messageDiv.classList.add('bg-red-100', 'text-red-700');
      } else {
        messageDiv.classList.add('bg-gray-200', 'text-gray-700');
      }
    }

    function renderCheckboxes() {
      const searchValue = document.getElementById('columnSearch').value.toLowerCase();
      const container = document.getElementById('columnCheckboxes');
      container.innerHTML = '';
      
      const filteredColumns = columns.filter(col => col.toLowerCase().includes(searchValue));

      filteredColumns.forEach(col => {
        const id = `col-${col.replace(/[^a-zA-Z0-9]/g, '')}`;
        const labelText = col.replace(/_/g, ' ').replace(/%/g, '%');
        const checkboxHtml = `
          <div class="flex items-center">
            <input type="checkbox" id="${id}" value="${col}" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <label for="${id}" class="ml-2 text-sm text-gray-700">${labelText}</label>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', checkboxHtml);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCheckboxes();
      document.getElementById('columnSearch').addEventListener('keyup', renderCheckboxes);

      const today = new Date();
      const lastWeek = new Date(today);
      lastWeek.setDate(today.getDate() - 7);
      document.getElementById('toDate').valueAsDate = today;
      document.getElementById('fromDate').valueAsDate = lastWeek;

      // Handle "Get from Cell" buttons
      document.getElementById('getStockSymbolFromCell').addEventListener('click', () => {
        google.script.run.withSuccessHandler(value => {
          document.getElementById('stockSymbol').value = value;
        }).withFailureHandler(handleFailure).getCellValue();
      });

      document.getElementById('getFromDateFromCell').addEventListener('click', () => {
        google.script.run.withSuccessHandler(value => {
          document.getElementById('fromDate').value = value;
        }).withFailureHandler(handleFailure).getCellValue();
      });

      document.getElementById('getToDateFromCell').addEventListener('click', () => {
        google.script.run.withSuccessHandler(value => {
          document.getElementById('toDate').value = value;
        }).withFailureHandler(handleFailure).getCellValue();
      });

      // Handle "Get from Range" button
      document.getElementById('getTickersFromRange').addEventListener('click', () => {
        google.script.run.withSuccessHandler(values => {
          const tickers = values.map(row => row[0]).filter(v => v);
          document.getElementById('tickerRange').value = tickers.join(',');
          displayMessage(`Loaded ${tickers.length} tickers from range.`, false);
        }).withFailureHandler(handleFailure).getCellRangeValues(document.getElementById('tickerRange').value);
      });

      // Handle "Fetch Data" button
      document.getElementById('fetchData').addEventListener('click', () => {
        const tickers = (document.getElementById('tickerRange').value || document.getElementById('stockSymbol').value)
                         .split(',')
                         .map(t => t.trim())
                         .filter(t => t.length > 0);
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const selectedColumns = Array.from(document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value);

        if (tickers.length === 0 || !fromDate || !toDate || selectedColumns.length === 0) {
          displayMessage("Please fill in all required fields and select at least one column.", true);
          return;
        }

        displayMessage(`Fetching data for ${tickers.length} ticker(s)...`);
        google.script.run.withSuccessHandler(response => {
          if (response.success) {
            displayMessage(response.message);
          } else {
            displayMessage(`Error: ${response.message}`, true);
          }
        }).withFailureHandler(handleFailure).fetchDataFromBackend({ tickers, fromDate, toDate, columns: selectedColumns });
      });

      function handleFailure(error) {
        console.error(error);
        displayMessage(`An unexpected error occurred: ${error.message}`, true);
      }
    });
  </script>
</body>
</html>
